{% extends "layout.html" %}

{% block content %}
<h2>Request Details</h2>

<a href="{{ url_for('index') }}">&larr; Back to Dashboard</a>
<hr>

<!-- ====== New Grid Layout: Info + Map (left) | Chat (right) ====== -->
<div class="req-main-grid">
  <div class="req-left-col">
    <!-- ===== Left section (Details + Actions) ===== -->
    <div class="req-left">
      <h3>{{ req.item_name }}</h3>
      <p>
          <strong>Status:</strong> {{ req.status }}<br>
          <strong>Submitted by:</strong> {{ req.disposer_profile.full_name }}<br>
          <strong>Address:</strong> {{ req.disposer_profile.address }}<br>
          <strong>Phone:</strong> {{ req.disposer_profile.phone_number }}<br>
          <strong>Submitted on:</strong> {{ req.submitted_on.strftime('%Y-%m-%d') }}
      </p>

      <h4>Description:</h4>
      <p style="white-space: pre-wrap;">{{ req.description }}</p>

      <h4>Images:</h4>
      {% if req.images %}
          {% for img in req.images %}
              <img src="{{ url_for('static', filename='uploads/' + img.filename) }}" 
                   alt="{{ req.item_name }}" style="max-width: 400px; border-radius: 6px; margin-bottom: 10px;">
          {% endfor %}
      {% else %}
          <p>No images were uploaded for this request.</p>
      {% endif %}

      <hr>

      {% if active_profile.role == 'collector' %}
        {% if req.status == 'Pending' %}

          {# üö´ Case 1: Collector has unclaimed this before #}
          {% if req.unclaimed_by_id == active_profile.id %}
            <p style="color:red; font-style:italic;">
              ‚ùå You have unclaimed this request earlier and cannot claim it again.
            </p>

          {# ‚úÖ Case 2: Approved for this collector (can now claim) #}
          {% elif req.claim_allowed_for_id == active_profile.id %}
            <p style="color:green; font-style:italic;">
              ‚úÖ The disposer has approved you to claim this item.
            </p>
            <form action="{{ url_for('claim_request', request_id=req.id) }}" method="POST">
              <button type="submit" class="btn btn-primary">Claim This Item</button>
            </form>

          {# üö´ Case 3: Approved for another collector #}
          {% elif req.claim_allowed_for_id and req.claim_allowed_for_id != active_profile.id %}
            <p style="color:red;">
              ‚ùå The disposer has approved another collector for this item.
            </p>

          {# ‚è≥ Case 4: Collector has already requested but waiting for approval #}
          {% elif claim_request %}
            <p style="color:#555; font-style:italic;">
              You‚Äôve already requested to claim this item. Please wait for the disposer‚Äôs approval.
            </p>

          {# üü¢ Case 5: New collector who hasn‚Äôt requested yet #}
          {% else %}
            <form action="{{ url_for('request_claim', request_id=req.id) }}" method="POST">
              <button type="submit" class="btn btn-primary">Request to Claim</button>
            </form>
          {% endif %}

        {% elif req.status == 'Accepted' %}
          {% if req.collector_profile_id == active_profile.id %}
            <p style="color:green;">‚úÖ You have successfully claimed this item. üöõ</p>
          {% else %}
            <p style="color:red;">This item has already been claimed by another collector.</p>
          {% endif %}
        {% endif %}
      {% endif %}

      {% if req.status == 'Accepted' and active_profile.role == 'collector' and req.collector_profile_id == active_profile.id %}
        <!-- ‚úÖ Only the assigned collector can mark as completed -->
        <form action="{{ url_for('mark_completed', request_id=req.id) }}" method="POST" style="margin-top:10px;">
          <button type="submit" class="btn btn-success">Mark as Completed ‚úÖ</button>
        </form>

      {% elif req.status == 'Completed' %}
        <p style="color:green; font-weight:bold;">
          ‚úÖ This request is completed.
          {% if req.completed_on %}
            <br><small>Completed on {{ req.completed_on.strftime('%Y-%m-%d %H:%M:%S') }}</small>
          {% endif %}
        </p>
      {% endif %}


      {% if active_profile.role == 'disposer' and req.status == 'Pending' %}
        <div class="claim-requests" style="margin-top:20px;">
          <h3>Claim Requests from Collectors</h3>

          {% if req.claim_allowed_for_id %}
            <div style="margin-bottom:15px; padding:10px; background:#fff3cd; border-radius:6px;">
              <p style="color:#856404;">
                ‚ö†Ô∏è You have approved a collector. If they haven‚Äôt claimed the item yet, you can revoke approval.
              </p>

              <!-- Revoke Approval Button -->
              <form action="{{ url_for('revoke_claim', request_id=req.id) }}" method="POST" style="margin-top:8px;">
                <button type="submit" class="btn btn-warning btn-sm" style="color:#000;">üîÑ Revoke Approval</button>
              </form>

              {% if req.approval_revoked_on %}
                <p style="font-size:13px; color:#888;">
                  ‚è±Ô∏è Last approval revoked on {{ req.approval_revoked_on.strftime('%Y-%m-%d %H:%M:%S') }}
                </p>
              {% endif %}
            </div>
          {% endif %}

          {% if claim_requests %}
            <ul style="list-style:none; padding:0;">
              {% for cr in claim_requests %}
                {% set is_approved_collector = (req.claim_allowed_for_id == cr.collector.id) %}

                {# ‚úÖ Show only the approved collector if one is approved #}
                {% if not req.claim_allowed_for_id or is_approved_collector %}
                  {% if not req.unclaimed_by_id or cr.collector_id != req.unclaimed_by_id %}
                    <li id="collector-{{ cr.collector.id }}" class="collector-chat-item"
                        style="margin-bottom:10px; 
                              background:{% if is_approved_collector %}#d4edda{% else %}#f8f9fa{% endif %}; 
                              padding:10px; 
                              border-radius:6px; 
                              transition:0.3s;">

                      <!-- Collector name + status -->
                      <strong>{{ cr.collector.profile_name }}</strong>

                      {% if is_approved_collector %}
                        <span style="color:green; font-weight:bold;">(Approved)</span>
                      {% elif req.unclaimed_by_id == cr.collector_id %}
                        <span style="color:red; font-style:italic;">(Unclaimed)</span>
                      {% endif %}

                      <!-- Chat Button -->
                      {% set chat_collector_id = req.collector_profile_id or cr.collector.id %}
                      <button class="btn btn-secondary btn-sm"
                              onclick="startChatWith('{{ chat_collector_id }}', '{{ cr.collector.profile_name }}')">
                        Chat
                      </button>

                      <!-- Approve Claim Button -->
                      {% if not req.claim_allowed_for_id %}
                        <form action="{{ url_for('approve_claim', request_id=req.id, collector_id=cr.collector.id) }}" 
                              method="POST" style="display:inline;">
                          <button type="submit" class="btn btn-success btn-sm"
                                  {% if req.unclaimed_by_id == cr.collector_id %}
                                    disabled title="This collector has unclaimed previously"
                                  {% endif %}>
                            Approve Claim
                          </button>
                        </form>
                      {% endif %}
                    </li>
                  {% endif %}
                {% endif %}
              {% endfor %}

            </ul>
          {% else %}
            <p>No collectors have requested to claim this item yet.</p>
          {% endif %}
        </div>
      {% endif %}


      {% if req.status != 'Pending' %}
        <h4>Claimed by: {{ req.collector_profile.full_name if req.collector_profile else 'Unknown' }}</h4>
      {% endif %}

      {% if can_edit %}
        <div style="margin-top:10px;">
          <a href="{{ url_for('edit_request', request_id=req.id) }}" 
            class="btn btn-secondary" 
            style="background:#ffc107;border:none;color:#222 !important;">
            ‚úèÔ∏è Edit Request (24h window)
          </a>
        </div>
      {% endif %}

      {% if can_unclaim %}
        <div style="margin-top:10px;">
          <form action="{{ url_for('unclaim_request', request_id=req.id) }}" method="POST" style="display:inline;">
            <button type="submit" class="btn btn-secondary" style="background:#dc3545;border:none;">
              ‚ùå Unclaim (1h window)
            </button>
          </form>
        </div>
      {% endif %}

      {% if active_profile.role == 'disposer' and req.status == 'Accepted' %}
        <div style="margin-top: 10px;">
          {% if req.location_access %}
            <form action="{{ url_for('toggle_location_access', request_id=req.id) }}" method="POST">
              <button type="submit" class="btn btn-secondary" style="background:#dc3545;border:none;">
                üîí Revoke Location Access
              </button>
            </form>
          {% else %}
            <form action="{{ url_for('toggle_location_access', request_id=req.id) }}" method="POST">
              <button type="submit" class="btn btn-secondary" style="background:#28a745;border:none;">
                üìç Share My Live Location
              </button>
            </form>
          {% endif %}
        </div>
      {% endif %}
    </div>

    <!-- ===== Map Section ===== -->
    {% if active_profile.role == 'collector' %} 
      <div class="req-right">
        <h3>Pickup Route</h3>
        {% if show_map %}
          <div class="map-wrap">
            <div id="map" class="map-box"></div>
            <div id="route-info" class="route-badge">Finding your location‚Ä¶</div>
          </div>
          <div class="map-controls">
            <button id="recenter-btn" type="button" class="btn btn-secondary">Recenter</button>
            <a id="nav-btn" href="#" target="_blank" class="btn btn-primary" style="display:none;">Start Navigation üöó</a>
          </div>
        {% elif active_profile.role == 'collector' and req.status == 'Pending' %}
          <p style="color: #888; font-style: italic;">üö´ You can view the pickup location only after claiming this request.</p>
        {% endif %}
      </div>
    {% endif %}
  </div>

<!-- ===== Right Column: Chat ===== -->
{% if can_chat %}
<div class="chat-section chat-side">
  <h3>Chat</h3>

  <!-- üí¨ Claim Status Indicator -->
  {% if active_profile.role == 'collector' %}
    {% if req.claim_allowed_for_id == active_profile.id %}
      <p style="color:green;font-size:14px;">‚úÖ You‚Äôve been approved to claim this item.</p>
    {% elif req.claim_allowed_for_id and req.claim_allowed_for_id != active_profile.id %}
      <p style="color:red;font-size:14px;">‚ùå This request has been approved for another collector.</p>
    {% else %}
      <p style="color:#555;font-size:14px;">üí¨ Chat is active while you await approval.</p>
    {% endif %}
  {% elif active_profile.role == 'disposer' %}
    {% if req.claim_allowed_for_id %}
      <p style="color:green;font-size:14px;">‚úÖ You have approved a collector. You can still chat here.</p>
    {% else %}
      <p style="color:#555;font-size:14px;">üí¨ Chat with collectors before approving a claim.</p>
    {% endif %}
  {% endif %}
  <!-- üí¨ End Claim Status Indicator -->

  <!-- Chat box -->
  <div id="chat-box" class="chat-box">
    {% for msg in chat_history %}
        {% set msg_class = 'me' if msg.sender_profile_id == active_profile.id else 'them' %}
        <div class="message {{ msg_class }}">
            {% if msg.sender_profile_id != active_profile.id %}
                <strong>{{ msg.sender.profile_name }}:</strong>
            {% endif %}
            <p>{{ msg.body }}</p>
            <small>
              {{ msg.timestamp.strftime('%Y-%m-%d %H:%M') }}
              {% if msg.sender_profile_id == active_profile.id %}
                ‚úì{% if msg.status == 'seen' %}‚úì{% endif %}
              {% endif %}
            </small>
        </div>
    {% endfor %}
  </div>

  <div id="typing-indicator"></div>

  <!-- Chat form -->
  <form id="chat-form" {% if not can_chat %}style="display:none;"{% endif %}>
    <div class="form-group">
      <input type="text" id="message-input" placeholder="Type your message..." autocomplete="off" />
      <button type="submit">Send</button>
    </div>
  </form>
</div>
{% endif %}
<!-- ====== Styles ====== -->
<!-- <style>
body {
  font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
  background-color: #f7f7f9;
  color: #222;
  margin: 0;
  padding: 0;
}

/* Main layout: left (details + map) | right (chat) */
.req-main-grid {
  display: grid;
  grid-template-columns: 2fr 1fr;
  gap: 30px;
  align-items: stretch;
  margin-top: 20px;
}

/* Stack info + map vertically */
.req-left-col {
  display: flex;
  flex-direction: column;
  gap: 20px;
}

/* Info + map boxes */
.req-left, .req-right {
  background: #ffffff;
  border: 1px solid #ddd;
  border-radius: 10px;
  padding: 20px;
  box-shadow: 0 1px 4px rgba(0,0,0,0.08);
}

/* Map */
.map-box {
  width: 100%;
  height: 400px;
  border-radius: 10px;
  border: 1px solid #ccc;
}
.map-wrap { position: relative; }
.route-badge {
  position: absolute;
  top: 10px;
  left: 10px;
  background: rgba(255,255,255,0.95);
  padding: 8px 12px;
  border-radius: 8px;
  font-weight: 500;
  box-shadow: 0 1px 4px rgba(0,0,0,0.3);
}
.map-controls {
  margin-top: 10px;
  display: flex;
  gap: 10px;
}

/* Chat */
.chat-side {
  display: flex;
  flex-direction: column;
  background: #ffffff;
  border: 1px solid #ddd;
  border-radius: 10px;
  padding: 20px;
  box-shadow: 0 1px 4px rgba(0,0,0,0.08);
}
.chat-box {
  flex-grow: 1;
  overflow-y: auto;
  background: #f1eeeb;
  padding: 10px;
  border-radius: 8px;
  border: 1px solid #ddd;
  margin-bottom: 10px;
}
.message {
  margin-bottom: 10px;
  padding: 8px 12px;
  border-radius: 8px;
  display: inline-block;
  max-width: 70%;
  word-wrap: break-word;
}
.message.me {
  background: #d4f8d4;
  align-self: flex-end;
  margin-left: auto;
}
.message.them {
  background: #ffffff;
  border: 1px solid #ddd;
}
#chat-form {
  display: flex;
  gap: 10px;
}
.chat-box {
  scroll-behavior: smooth;
}
#message-input {
  flex: 1;
  padding: 8px 12px;
  border: 1px solid #ccc;
  border-radius: 6px;
  font-size: 14px;
}
#typing-indicator {
  font-style: italic;
  color: #666;
  margin-top: 5px;
}

/* Buttons */
button, .btn, a.btn {
  display: inline-block;
  padding: 8px 16px;
  border: none;
  border-radius: 6px;
  text-decoration: none;
  font-weight: 500;
  font-size: 14px;
  cursor: pointer;
  transition: 0.25s ease;
  color: #fff !important;
}
.btn-primary, #nav-btn { background-color: #28a745; }
.btn-primary:hover, #nav-btn:hover { background-color: #218838; }
.btn-secondary, #recenter-btn { background-color: #007bff; }
.btn-secondary:hover, #recenter-btn:hover { background-color: #0056b3; }

/* Responsive */
@media (max-width: 1024px) {
  .req-main-grid { grid-template-columns: 1fr; }
  .chat-side { order: 3; }
}
</style> -->

<!-- ====== Collector Map JS ====== -->
{% if active_profile.role == 'collector' %}
  {% set gmaps_script %}
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDa6JfHpSixfrXkABi4CUSXIvZjAhP0TEc"></script>
  <script type="application/json" id="map-data">
    {
      "disposer": {{ disposer_loc | tojson }},
      "collector": {{ collector_loc | tojson }},
      "locationAccess": {{ req.location_access | tojson }}
    }
  </script>

  <script>
    const mapData = JSON.parse(document.getElementById("map-data").textContent);
    const disposer = mapData.disposer;
    let collector = mapData.collector;
    const locationAccess = mapData.locationAccess;

    const routeInfoEl = document.getElementById("route-info");
    const navBtn = document.getElementById("nav-btn");
    const recenterBtn = document.getElementById("recenter-btn");
    let map, bounds, disposerMarker, collectorMarker;

    function initMap() {
      if (!disposer) {
        map = new google.maps.Map(document.getElementById("map"), {
          center: { lat: 20.5937, lng: 78.9629 },
          zoom: 5,
        });
        if (routeInfoEl) routeInfoEl.textContent = "Disposer location unavailable.";
        return;
      }

      map = new google.maps.Map(document.getElementById("map"), {
        center: disposer,
        zoom: 14,
      });

      bounds = new google.maps.LatLngBounds();

      disposerMarker = new google.maps.Marker({
        position: disposer,
        map,
        label: "D",
        title: "Disposer Location",
      });
      bounds.extend(disposer);

      if (collector) {
        collectorMarker = new google.maps.Marker({
          position: collector,
          map,
          label: "You",
          title: "Your Location",
        });
        bounds.extend(collector);
        map.fitBounds(bounds);
        updateNavLink();
      } else {
        getCollectorLocation(true);
      }

      if (recenterBtn) recenterBtn.onclick = () => map.fitBounds(bounds);
    }

    // ‚úÖ Enhanced Smart Navigation Logic
    async function updateNavLink() {
      try {
        if (!collector) return;

        let destinationLat, destinationLng;
        let labelText = "Start Navigation üöó";

        // If disposer has shared live access
        if (locationAccess) {
          const res = await fetch("{{ url_for('get_disposer_location', request_id=req.id) }}");
          const data = await res.json();

          if (data.lat && data.lng) {
            destinationLat = data.lat;
            destinationLng = data.lng;
            labelText = "Navigate to Disposer (Live) üöó";
          }
        }

        // If live data not available, use default/static disposer location
        if (!destinationLat || !destinationLng) {
          destinationLat = disposer.lat;
          destinationLng = disposer.lng;
          labelText = "Navigate to Pickup Address üöó";
        }

        const url = `https://www.google.com/maps/dir/?api=1&origin=${collector.lat},${collector.lng}&destination=${destinationLat},${destinationLng}&travelmode=driving`;

        if (navBtn) {
          navBtn.href = url;
          navBtn.innerText = labelText;
          navBtn.style.display = "inline-block";
        }
      } catch (err) {
        console.warn("Navigation setup failed:", err);
      }
    }

    function getCollectorLocation(initial = false) {
      if (!navigator.geolocation) {
        if (routeInfoEl) routeInfoEl.textContent = "Geolocation not supported.";
        return;
      }

      navigator.geolocation.getCurrentPosition(
        async (pos) => {
          collector = { lat: pos.coords.latitude, lng: pos.coords.longitude };

          try {
            await fetch("{{ url_for('update_location') }}", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                latitude: collector.lat,
                longitude: collector.lng,
              }),
            });
          } catch (e) {
            console.warn("Failed to update location:", e);
          }

          if (initial)
            collectorMarker = new google.maps.Marker({ position: collector, map, label: "You", title: "Your Location" });
          else if (collectorMarker) collectorMarker.setPosition(collector);

          bounds.extend(collector);
          map.fitBounds(bounds);
          updateNavLink();
        },
        (err) => {
          if (routeInfoEl) routeInfoEl.textContent = "Location permission denied.";
        },
        { enableHighAccuracy: true, maximumAge: 5000, timeout: 10000 }
      );
    }

    // ====== NEW FUNCTION ======
    function getDisposerLocation() {
      if (!locationAccess) {
        console.log("Disposer has not allowed live tracking.");
        return;
      }

      fetch("{{ url_for('get_disposer_location', request_id=req.id) }}")
        .then((res) => res.json())
        .then((data) => {
          if (data.lat && data.lng) {
            const disposerPos = { lat: data.lat, lng: data.lng };
            if (disposerMarker) {
              disposerMarker.setPosition(disposerPos);
            } else {
              disposerMarker = new google.maps.Marker({
                position: disposerPos,
                map,
                label: "D",
                title: "Disposer Live Location"
              });
            }
            bounds.extend(disposerPos);
            map.fitBounds(bounds);
            updateNavLink();
          }
        })
        .catch((err) => console.warn("Error fetching disposer location:", err));
    }

    initMap();
    setInterval(() => {
      getCollectorLocation(false);
      getDisposerLocation();
    }, 10000);

  </script>
  {% endset %}
  {{ gmaps_script | safe }}
{% endif %}

{% if active_profile.role == 'disposer' %}
  {% set disposer_script %}
    <script type="application/json" id="disposer-data">
      { "locationAccess": {{ req.location_access | tojson }} }
    </script>

    <script>
      const disposerData = JSON.parse(document.getElementById("disposer-data").textContent);
      const hasAccess = disposerData.locationAccess;

  function updateDisposerLiveLocation() {
    if (!navigator.geolocation) {
      console.warn("Geolocation not supported by browser.");
      return;
    }

  navigator.geolocation.getCurrentPosition(
    async (pos) => {
      try {
        await fetch("{{ url_for('update_disposer_location') }}", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            latitude: pos.coords.latitude,
            longitude: pos.coords.longitude,
          }),
        });
      } catch (e) {
        console.warn("Failed to update disposer location:", e);
      }
    },
    (err) => console.warn("Location permission denied:", err),
    { enableHighAccuracy: true, maximumAge: 5000, timeout: 10000 }
  );
}

// ‚úÖ Run update loop only if disposer shared access
    if (hasAccess) {
      setInterval(updateDisposerLiveLocation, 10000);
    }
  </script>
  {% endset %}
  {{ disposer_script | safe }}
{% endif %}


<!-- ====== Chat JS ====== -->
{% if can_chat %}
  {% set script %}
  <script>
    var socket = io.connect(window.location.origin);
    var requestId = "{{ req.id }}";
    var currentUser = "{{ active_profile.profile_name }}";
    var currentUserId = parseInt("{{ active_profile.id }}");
    var disposerId = "{{ req.disposer_profile_id }}";
    var userRole = "{{ active_profile.role }}";
    // Get the official collector ID assigned to this request (if any)
    var assignedCollectorId = "{{ req.collector_profile_id or '' }}";
    if (assignedCollectorId === "None") assignedCollectorId = "";
    var room = null;
    var activeCollectorId = null;

    // --- Auto-join for collector ---
    if (userRole === "collector") {
      room = `${requestId}_${currentUserId}_${disposerId}`;
      socket.emit("join_room", { room });
      console.log("Collector joined room:", room);
    } else if (userRole === "disposer") {
      if (assignedCollectorId) {
        // ‚úÖ If collector has already claimed (Accepted), disposer auto-joins that chat room
        room = `${requestId}_${assignedCollectorId}_${disposerId}`;
        socket.emit("join_room", { room });
        console.log("üü¢ Disposer auto-joined active room:", room);

        // ‚úÖ Automatically fetch chat history for the assigned collector
        const chatBox = document.getElementById("chat-box");
        chatBox.innerHTML = `<p style='color:#555;'>Loading chat with assigned collector...</p>`;

        fetch(`/chat_history/${requestId}/${assignedCollectorId}`)
          .then(res => res.json())
          .then(data => {
            chatBox.innerHTML = "";
            if (data.messages.length === 0) {
              chatBox.innerHTML = `<p style='color:#999;'>No previous messages yet. Start the conversation!</p>`;
              return;
            }

            data.messages.forEach(msg => {
              const div = document.createElement("div");
              div.className = msg.sender_id === currentUserId ? "message me" : "message them";
              div.innerHTML =
                (msg.sender_name !== currentUser ? `<strong>${msg.sender_name}:</strong>` : "") +
                `<p>${msg.body}</p><small>${msg.timestamp}${msg.sender_id === currentUserId && msg.status === 'seen' ? ' ‚úì‚úì' : msg.sender_id === currentUserId ? ' ‚úì' : ''}</small>`;
              chatBox.appendChild(div);
            });
            chatBox.scrollTop = chatBox.scrollHeight;
            console.log(`üìú Loaded ${data.messages.length} messages for auto-joined chat.`);
          })
          .catch(err => {
            console.error("‚ùå Error loading chat history:", err);
            chatBox.innerHTML = `<p style='color:red;'>Failed to load chat history.</p>`;
          });
      } else {
        console.log("üïê Disposer waiting ‚Äî no active collector assigned yet.");
      }
    }


    // Leave current room when navigating away
    window.onbeforeunload = function () {
      if (room) socket.emit("leave_room", { room });
    };

    // --- Send message handler ---
    var chatForm = document.getElementById("chat-form");
    chatForm.onsubmit = function (e) {
      e.preventDefault();
      var input = document.getElementById("message-input");
      var message = input.value.trim();
      if (!message || !room) return;

      socket.emit("send_message", {
        room: room,
        message: message,
        profile_id: currentUserId
      }, function () {
        console.log("üì§ Sent message to room:", room);
        input.value = ""; // clear after message saved
      });
    };

    // --- Typing indicator ---
    var typingIndicator = document.getElementById("typing-indicator");
    var messageInput = document.getElementById("message-input");
    messageInput.addEventListener("input", function () {
      if (room) socket.emit("typing", { room: room, sender_name: currentUser });
    });

    socket.on("display_typing", function (data) {
      typingIndicator.innerText = data.sender_name + " is typing...";
      clearTimeout(window.typingTimeout);
      window.typingTimeout = setTimeout(() => typingIndicator.innerText = "", 1500);
    });

    // --- Receive messages ---
    socket.on("chat_message", function (data) {
      console.log("üì® Received message:", data);
      var box = document.getElementById("chat-box");
      var div = document.createElement("div");
      div.className = data.sender_name === currentUser ? "message me" : "message them";
      div.innerHTML =
        (data.sender_name !== currentUser ? "<strong>" + data.sender_name + ":</strong>" : "") +
        "<p>" + data.message + "</p>" +
        "<small>" + data.timestamp + (data.sender_name === currentUser ? " ‚úì" : "") + "</small>";
      box.appendChild(div);
      box.scrollTop = box.scrollHeight;
    });

    // --- For disposer: start chat with specific collector ---
    function startChatWith(collectorId, collectorName) {
      // ‚úÖ Fallback: if collectorId is missing, use assigned one from backend
      if (!collectorId || collectorId === "None") {
        collectorId = "{{ req.collector_profile_id or '' }}";
      }

      // Leave any existing room
      if (room) socket.emit("leave_room", { room });

      activeCollectorId = parseInt(collectorId);
      room = `${requestId}_${collectorId}_${disposerId}`;
      socket.emit("join_room", { room });

      console.log(`üí¨ Disposer switched to chat with ${collectorName} | Room: ${room}`);

      const chatBox = document.getElementById("chat-box");
      chatBox.innerHTML = `<p style='color:#555;'>Loading chat with <strong>${collectorName}</strong>...</p>`;

      // ‚úÖ Fetch previous chat messages dynamically
      fetch(`/chat_history/${requestId}/${collectorId}`)
        .then(res => res.json())
        .then(data => {
          chatBox.innerHTML = "";
          if (data.messages.length === 0) {
            chatBox.innerHTML = `<p style='color:#999;'>No previous messages. Start the conversation!</p>`;
            return;
          }

          data.messages.forEach(msg => {
            const div = document.createElement("div");
            div.className = msg.sender_id === currentUserId ? "message me" : "message them";
            div.innerHTML =
              (msg.sender_name !== currentUser ? `<strong>${msg.sender_name}:</strong>` : "") +
              `<p>${msg.body}</p><small>${msg.timestamp}${msg.sender_id === currentUserId && msg.status === 'seen' ? ' ‚úì‚úì' : msg.sender_id === currentUserId ? ' ‚úì' : ''}</small>`;
            chatBox.appendChild(div);
          });

          chatBox.scrollTop = chatBox.scrollHeight;

          // ‚úÖ Mark messages as seen when this chat opens
          socket.emit("mark_seen", {
            room: room,
            profile_id: currentUserId
          });
        })
        .catch(err => {
          console.error("‚ùå Error loading chat:", err);
          chatBox.innerHTML = `<p style='color:red;'>Failed to load chat with ${collectorName}</p>`;
        });
    }

    window.startChatWith = startChatWith;

    // --- Highlight active collector in UI ---
    function highlightActiveCollector(collectorId) {
      document.querySelectorAll(".collector-chat-item").forEach(el => {
        el.classList.remove("active-chat");
      });
      const el = document.getElementById("collector-" + collectorId);
      if (el) el.classList.add("active-chat");
    }

    // --- Mark messages as seen (update UI on both sides) ---
    socket.on("messages_seen", (data) => {
      console.log("üëÅÔ∏è Messages marked as seen in:", data.room);
      document.querySelectorAll(".message.me small").forEach(el => {
        if (!el.innerText.includes("‚úì‚úì")) {
          el.innerText = el.innerText.replace("‚úì", "‚úì‚úì");
        }
      });
    });
  </script>


  <style>
  .collector-chat-item.active-chat {
    background: #d4f8d4 !important;
    border: 1px solid #28a745;
    box-shadow: 0 0 5px rgba(40, 167, 69, 0.3);
    transition: 0.3s;
  }
  </style>

  {% endset %}
  {{ script | safe }}
{% endif %}
{% endblock %}
